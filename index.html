<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube İndirici</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #ff0000;
            --secondary: #282828;
            --light: #f8f9fa;
            --dark: #212529;
            --error: #dc3545;
            --success: #28a745;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--light);
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 20px;
        }
        
        .input-group {
            display: flex;
            margin-bottom: 20px;
        }
        
        input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .video-info {
            margin-bottom: 20px;
        }
        
        .thumbnail {
            max-width: 100%;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .format {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: #f5f5f5;
            border-radius: 4px;
        }
        
        .download-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .history {
            margin-top: 30px;
        }
        
        .history-item {
            padding: 8px;
            margin: 5px 0;
            background: #f0f0f0;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="https://www.youtube.com/img/desktop/yt_1200.png" class="logo" alt="YouTube">
            <h1>YouTube İndirici</h1>
        </header>
        
        <div class="content">
            <div class="input-group">
                <input type="text" id="urlInput" placeholder="YouTube URL'si girin...">
                <button id="searchBtn"><i class="fas fa-search"></i> Ara</button>
            </div>
            
            <div id="result"></div>
            <div class="history">
                <h3>İndirme Geçmişi</h3>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <script>
       document.addEventListener('DOMContentLoaded', function() {
    // DOM Elementleri
    const urlInput = document.getElementById('urlInput');
    const searchBtn = document.getElementById('searchBtn');
    const resultDiv = document.getElementById('result');
    const historyList = document.getElementById('historyList');
    
    // Global değişkenler
    let currentVideoInfo = null;
    const MAX_HISTORY_ITEMS = 10;

    // Event Listeners
    searchBtn.addEventListener('click', handleSearch);
    urlInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleSearch();
    });

    // İlk yüklemede geçmişi göster
    loadDownloadHistory();

    // Fonksiyonlar
    async function handleSearch() {
        const url = urlInput.value.trim();
        
        if (!url) {
            showError('Lütfen bir YouTube URL\'si girin');
            return;
        }

        try {
            showLoading('Video bilgileri alınıyor...');
            
            const info = await getVideoInfo(url);
            currentVideoInfo = {
                url: url,
                title: info.title,
                channel: info.channel,
                duration: info.duration
            };
            
            displayVideoInfo(info);
        } catch (error) {
            showError(error.message);
        } finally {
            hideLoading();
        }
    }

    async function getVideoInfo(url) {
        try {
            const response = await fetch('/api/info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Bilinmeyen hata');
            }

            return await response.json();
        } catch (error) {
            console.error('API Hatası:', error);
            throw new Error('Video bilgileri alınamadı: ' + error.message);
        }
    }

    function displayVideoInfo(info) {
        resultDiv.innerHTML = `
            <div class="video-info">
                <h2>${info.title}</h2>
                <p>Kanal: ${info.channel}</p>
                <p>Süre: ${formatDuration(info.duration)}</p>
                ${info.thumbnail ? `<img src="${info.thumbnail}" class="thumbnail" alt="Video thumbnail">` : ''}
                
                <div class="formats-container">
                    <h3>Video Formatları</h3>
                    ${info.formats.map(format => `
                        <div class="format">
                            <span>${format.res || 'Standart'} - ${format.ext.toUpperCase()} ${format.note ? `(${format.note})` : ''}</span>
                            <button class="download-btn" 
                                    onclick="downloadVideo('${format.id}', 'video')">
                                <i class="fas fa-download"></i> İndir
                            </button>
                        </div>
                    `).join('')}
                    
                    <h3>Ses Formatı</h3>
                    <div class="format">
                        <span>MP3 (Yüksek Kalite)</span>
                        <button class="download-btn" onclick="downloadVideo('', 'audio')">
                            <i class="fas fa-download"></i> İndir
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    async function downloadVideo(formatId, type) {
        if (!currentVideoInfo || !currentVideoInfo.url) {
            showError('Önce bir video aramalısınız');
            return;
        }

        try {
            showLoading(`${type === 'audio' ? 'MP3' : 'Video'} indiriliyor...`);
            
            const response = await fetch('/api/download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url: currentVideoInfo.url,
                    type: type,
                    format_id: formatId
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'İndirme başarısız');
            }

            const data = await response.json();
            startDownload(data.filename);
            addToHistory(data.filename, currentVideoInfo.title);
            
            showMessage(`${type === 'audio' ? 'MP3' : 'Video'} başarıyla indirildi!`);
        } catch (error) {
            showError('İndirme hatası: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    function startDownload(filename) {
        const downloadUrl = `/downloads/${encodeURIComponent(filename)}`;
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Yardımcı Fonksiyonlar
    function formatDuration(seconds) {
        if (!seconds) return 'Bilinmiyor';
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    function showLoading(message = 'Yükleniyor...') {
        resultDiv.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <p>${message}</p>
            </div>
        `;
    }

    function hideLoading() {
        const loadingElement = resultDiv.querySelector('.loading');
        if (loadingElement) {
            loadingElement.remove();
        }
    }

    function showError(message) {
        resultDiv.innerHTML = `
            <div class="error">
                <i class="fas fa-exclamation-circle"></i>
                <span>${message}</span>
            </div>
        `;
    }

    function showMessage(message) {
        const msgElement = document.createElement('div');
        msgElement.className = 'message';
        msgElement.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <span>${message}</span>
        `;
        resultDiv.prepend(msgElement);
        setTimeout(() => msgElement.remove(), 5000);
    }

    // Geçmiş İşlemleri
    function loadDownloadHistory() {
        const history = JSON.parse(localStorage.getItem('downloadHistory')) || [];
        historyList.innerHTML = history.map(item => `
            <div class="history-item">
                <span class="history-title">${item.title}</span>
                <span class="history-filename">${item.filename}</span>
                <span class="history-date">${new Date(item.date).toLocaleString()}</span>
            </div>
        `).join('');
    }

    function addToHistory(filename, title) {
        const history = JSON.parse(localStorage.getItem('downloadHistory')) || [];
        
        history.unshift({
            filename: filename,
            title: title,
            date: new Date().toISOString()
        });

        // Sadece son 10 kaydı tut
        const limitedHistory = history.slice(0, MAX_HISTORY_ITEMS);
        localStorage.setItem('downloadHistory', JSON.stringify(limitedHistory));
        loadDownloadHistory();
    }

    // Global fonksiyonlar (HTML'den çağrılabilmesi için)
    window.downloadVideo = downloadVideo;
});
</script>
</body>
</html>